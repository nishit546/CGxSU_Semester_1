# Middleware & Routing in Express.js

## How Requests Flow Through an Express Application

## 1. Why Middleware Exists

So far, you have seen Express routes like this:

```js
app.get("/users", (req, res) => {
  res.send("Users list");
});
```

This works well — but real applications need to do **extra work before and after routes**, such as:

* Logging requests
* Validating input
* Checking authentication
* Parsing request body
* Handling errors

**Middleware exists to handle this shared logic.**

---

## 2. What is Middleware? 

A **middleware** is a function that:

* Runs **before the final route handler**
* Has access to `req` and `res`
* Can either:

  * Pass control forward
  * Or stop the request

Think of middleware as **a checkpoint**.

---

## 3. The Request Flow in Express

![Image](https://www.javascripttutorial.net/wp-content/uploads/2024/08/express-middleware.png)

![Image](https://media2.dev.to/dynamic/image/width%3D800%2Cheight%3D%2Cfit%3Dscale-down%2Cgravity%3Dauto%2Cformat%3Dauto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fi%2F73eusy0bc095c9w8tstw.png)

When a request hits an Express app:

1. Request enters the app
2. Middleware runs **one by one**
3. Route handler runs
4. Response is sent

If middleware does not pass control forward, the request **stops there**.

---

## 4. The `next()` Function

Middleware uses a function called `next()`.

* Calling `next()` → move to the next middleware or route
* Not calling `next()` → request stops

---

### Simple Middleware Example

```js
app.use((req, res, next) => {

  console.log("Request received");

  next(); // move forward

});
```

What happens:

* Message is logged
* Request continues to route handler

---

## 5. Built-in Middleware in Express

Express already provides useful middleware.

---

### `express.json()` – Reading JSON Data

```js
app.use(express.json());
```

What it does:

* Reads JSON from request body
* Converts it into `req.body`

Without this:

* `req.body` will be `undefined`

This middleware should be added **before routes**.

---

## 6. Custom Middleware 

Let’s create a very simple custom middleware.

### Example: Request Logger

```js
function requestLogger(req, res, next) {

  console.log("Method:", req.method);
  console.log("URL:", req.url);

  next();
}

app.use(requestLogger);
```

Why this is useful:

* Helps debugging
* Common in real applications
* Shows middleware reusability

---

## 7. Middleware Can Stop a Request

Middleware does not always have to call `next()`.

### Example: Blocking a Request

```js
app.use((req, res, next) => {

  const allowed = false;

  if (!allowed) {
    res.status(403).send("Access denied");
    return;
  }

  next();
});
```

This shows:

* Middleware can send a response
* Route handler will **never execute**

---

## 8. What is Routing in Express?

Routing means:

> Deciding **which code runs** for a given HTTP method and URL.

Example:

```js
app.get("/users", handler);
app.post("/users", handler);
```

Each route:

* Matches an HTTP method
* Matches a URL pattern
* Executes a handler function

---

## 9. Route Order Matters

![Image](https://developer.mozilla.org/en-US/docs/Learn_web_development/Extensions/Server-side/Express_Nodejs/routes/mvc_express.png)

![Image](https://expressjs.com/images/express-mw.png)

Express checks routes **top to bottom**.

Example:

```js
app.get("/users/:id", handler1);
app.get("/users/all", handler2);
```

Request:

```
GET /users/all
```

This will match `:id` first ❌

Correct order:

```js
app.get("/users/all", handler2);
app.get("/users/:id", handler1);
```

This is a **very common beginner mistake**.

---

## 10. Using `express.Router()` 

As apps grow, routes should be grouped.

```js
const express = require("express");
const router = express.Router();

router.get("/users", (req, res) => {
  res.send("Users route");
});

module.exports = router;
```

Then in main file:

```js
app.use("/", router);
```

This keeps code organized without complexity.

---


## 11. Rules to Remember

* Middleware runs **in order**
* `next()` is mandatory to continue
* Middleware can end requests
* Route order matters
* `express.json()` must come before routes
* Routing decides *what code runs*

* Middleware is shared logic for requests
* Express request flow is linear
* `next()` controls execution
* Routing maps method + URL to code
* Order matters in both middleware and routes

---
